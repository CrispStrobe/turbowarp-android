# TurboWarp Mobile — Build Guide

Everything you need to compile and run TurboWarp on all platforms.

---

## Repository layout

```
turbowarp/
├── scratch-gui/          # Web app (React/Webpack) — the actual GUI
├── turbowarp-android/    # Capacitor shell (Android + iOS native projects)
│   ├── android/          # Android Studio project
│   ├── ios/              # Xcode project (generated by `npx cap add ios`)
│   └── capacitor.config.json
└── extensions/           # Custom extension JS files
```

The Capacitor project treats `scratch-gui/build/` as its web root
(`"webDir": "../scratch-gui/build"` in `capacitor.config.json`).

---

## Prerequisites

### All platforms
- **Node.js** ≥ 18 (includes npm)
- Install dependencies once in each sub-project:

```bash
cd turbowarp/scratch-gui && npm install
cd turbowarp/turbowarp-android && npm install
```

### Android
- **Java 17+** (JDK, not JRE)
- **Android Studio** (latest stable) — includes the Android SDK
  - SDK Platform: Android 14 (API 36) or higher
  - Build Tools matching `compileSdkVersion` (currently 36)
- For command-line builds: `ANDROID_HOME` or `ANDROID_SDK_ROOT` env var set

### iOS
- **macOS only** — Xcode is required; iOS builds cannot be produced on Linux/Windows
- **Xcode** ≥ 15 (from the Mac App Store)
- **CocoaPods**: `sudo gem install cocoapods` (or via Homebrew: `brew install cocoapods`)
- An Apple Developer account (free is enough to run on a personal device via Xcode;
  distribution to the App Store requires a paid membership)

---

## 1. Web / browser (development)

```bash
cd scratch-gui
npm start          # Webpack dev server on http://localhost:8601
```

Open `http://localhost:8601` in any browser.

To produce an optimised production build:
```bash
npm run build      # outputs to scratch-gui/build/
```

---

## 2. Android

### Quick start (connected device or emulator)

```bash
# From turbowarp-android/:
npm run build:android   # builds scratch-gui + syncs assets into android/
npm run open:android    # opens Android Studio
# — or —
npm run run:android     # builds & deploys directly to attached device/emulator
```

`npm run build:android` expands to:
1. `cd ../scratch-gui && npm run build` — production Webpack build
2. `npx cap sync android` — copies `build/` into `android/app/src/main/assets/public/` and updates plugin metadata

#### Optional: copy custom extensions
```bash
npm run copy:extensions
```
This copies `.js` files from `../extensions/extensions/` into the Android assets folder so they are available offline. Run this after `build:android` if you want extensions bundled.

### Release / signing

Android Studio handles signing. Create a keystore once (`Build → Generate Signed Bundle/APK`) and store the credentials in `android/keystore.properties` (never commit this file):

```properties
storeFile=../my-release-key.jks
storePassword=...
keyAlias=...
keyPassword=...
```

Then reference it in `android/app/build.gradle` under `signingConfigs`.

### Minimum SDK

`minSdkVersion = 24` (Android 7.0, Nougat). The file picker intents (`ACTION_CREATE_DOCUMENT`, `ACTION_OPEN_DOCUMENT`) require API 19+, so this is fine.

---

## 3. iOS

### Prerequisites check

```bash
xcode-select --install     # Command-line tools
pod --version               # Should print a version number
```

### First-time pod install

After `npx cap add ios` (already done) or whenever native dependencies change:

```bash
cd turbowarp-android/ios/App
pod install
```

This generates `App.xcworkspace`. **Always open the `.xcworkspace`, not `.xcodeproj`.**

### Quick start

```bash
# From turbowarp-android/:
npm run build:ios           # builds scratch-gui + syncs into ios/
npm run open:ios            # opens Xcode (App.xcworkspace)
```

In Xcode:
1. Select your target device or simulator from the toolbar.
2. Set `Signing & Capabilities → Team` to your Apple Developer account.
3. Press **Run (▶)**.

For command-line deploy to an attached device:
```bash
npm run run:ios
```

### Bundle ID

The bundle identifier is `com.crispstrobe.turbowarp` (set in `capacitor.config.json` and inherited by Xcode). Change it in Xcode under `Signing & Capabilities` if needed.

### Orientation

`Info.plist` allows Portrait, Landscape Left, and Landscape Right on iPhone. iPad additionally allows Portrait Upside-Down. Edit `ios/App/App/Info.plist` to change.

---

## 4. Full rebuild (all platforms)

```bash
# From turbowarp-android/:
npm run build:all   # web build + cap sync (both android and ios)
```

Then open Android Studio or Xcode to deploy.

---

## CORS / network / server configuration

**Short answer: no patches required.** Everything is already configured correctly. Details below.

### How the WebView sees itself

`capacitor.config.json` sets:
```json
"server": {
  "androidScheme": "https",
  "hostname": "localhost"
}
```

This makes the embedded WebView load from `https://localhost` (not `file://` or `capacitor://`). This is the standard Capacitor production setup and avoids mixed-content blocks.

### External network requests

The app makes outbound HTTPS requests to these domains:

| Domain | Purpose | CORS |
|---|---|---|
| `assets.scratch.mit.edu` | Sprite / costume / sound CDN | `Access-Control-Allow-Origin: *` |
| `projects.scratch.mit.edu` | Scratch project files | `Access-Control-Allow-Origin: *` |
| `trampoline.turbowarp.org` | CORS proxy for project metadata & thumbnails | designed to allow all origins |
| Local `extensions/` assets | Custom extensions (bundled in APK/IPA) | same origin, no CORS |

All external endpoints use HTTPS and return permissive CORS headers, so no proxy or server-side changes are needed.

### iOS App Transport Security (ATS)

iOS enforces HTTPS for all outbound connections by default. Because every domain above uses HTTPS, **no ATS exception entries are needed** in `Info.plist`. Do not add `NSAllowsArbitraryLoads: true` — it is unnecessary and would flag App Store review.

### Android network security

No `network_security_config.xml` is needed. All connections are HTTPS; there is no cleartext HTTP traffic. The manifest does not reference a custom network security config, which is correct.

### Vercel / hosted web version

If you deploy `scratch-gui/build/` to Vercel (or any static host), no server-side CORS headers need to be configured — the app only fetches from the CDN domains above, which already allow `*`.

For the Webpack dev server (`npm start`), `disableHostCheck: true` is set so you can access it from a device on the same LAN at `http://<machine-ip>:8601`.

---

## Troubleshooting

### Port 8601 already in use
```bash
lsof -ti :8601 | xargs kill -9
```

### `cap sync` complains about SPM compatibility
The Cordova Bluetooth Serial plugin does not support Swift Package Manager — this is expected. The warning is harmless; the plugin is linked via CocoaPods (`.m` bridge + compiled library).

### iOS: "No development team" Xcode error
In Xcode → `Signing & Capabilities`, select your Apple ID team. For device testing a free account works; for App Store submission you need a paid membership.

### Android: `ANDROID_HOME` not set
Add to your shell profile:
```bash
export ANDROID_HOME=$HOME/Library/Android/sdk   # macOS default
export PATH=$PATH:$ANDROID_HOME/platform-tools
```

### Bluetooth Serial plugin not working on iOS
`cordova-plugin-bluetooth-serial` is an Android-only Cordova plugin. On iOS, `window.bluetoothSerial` will be undefined. The bridge script (`inject-android-bridge.js`) is loaded unconditionally but only references `bluetoothSerial` inside event handlers, so it does not crash at load time. A native iOS BLE implementation would need to be built separately if required.

### Addon settings not opening on Capacitor
On Capacitor, addon settings open as an in-app modal (via `openAddonSettingsModal`). On the web they open in a new window (`addons.html`). If the modal is blank, ensure the `addon-settings-modal` webpack chunk is present in `build/js/`.
